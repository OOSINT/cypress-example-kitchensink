version: 0.2
variables:
  npm_config_cache: $CI_PROJECT_DIR/.npm
  CYPRESS_CACHE_FOLDER: $CI_PROJECT_DIR/.cache/Cypress
applications:
  - appRoot: app
    frontend:
      phases:
        preBuild:
          commands:
            - rm -rf node_modules && rm -rf package-lock.json
            - npm install
            - cypress verify
            - echo "From Repo"
        build:
          commands:
            - npm run build
      artifacts:
        baseDirectory: app
        files:
          - "**/*"
      cache:
        paths:
          - node_modules/**/*
          - /root/.cache/Cypress/**/*
          - ~/.cache
    test:
      artifacts:
        baseDirectory: cypress
        configFilePath: "**/mochawesome.json"
        files:
          - "**/*.png"
          - "**/*.mp4"
      cache:
        paths:
          - node_modules/**/*
          - /root/.cache/Cypress/**/*
          - ~/.cache
      phases:
        preTest:
          commands:
            - npm install
            - npm install wait-on
            - npm install mocha mochawesome mochawesome-merge mochawesome-report-generator
            - "npm start & npx wait-on http://127.0.0.1:8080"
        test:
          commands:
            - 'npx cypress run --reporter mochawesome --reporter-options "reportDir=cypress/report/mochawesome-report,overwrite=false,html=false,json=true,timestamp=mmddyyyy_HHMMss"'
        postTest:
          commands:
            - npx mochawesome-merge@4 cypress/report/mochawesome-report/*.json > cypress/report/mochawesome.json
